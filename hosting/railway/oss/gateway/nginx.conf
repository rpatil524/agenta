events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Railway private networking DNS resolver (IPv6).
    # Using variable-based proxy_pass forces Nginx to re-resolve DNS on every
    # request via this resolver, instead of caching the IP from startup forever.
    # Without this, any upstream service redeploy changes its internal IP and
    # Nginx keeps connecting to the dead old IP, causing 504 gateway timeouts.
    #
    # Note: variable-based proxy_pass does not do automatic URI stripping like
    # literal proxy_pass with a trailing slash. We use rewrite to strip path
    # prefixes explicitly.
    resolver [fd12::10] valid=5s ipv6=off;

    server {
        listen ${PORT};

        client_max_body_size 32m;

        # Timeouts for private network connections
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;

        location /api/ {
            set $api_upstream "api.railway.internal:8000";
            rewrite ^/api/(.*)$ /$1 break;
            proxy_pass http://$api_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/ {
            set $services_upstream "services.railway.internal:80";
            rewrite ^/services/(.*)$ /$1 break;
            proxy_pass http://$services_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            set $web_upstream "web.railway.internal:8080";
            proxy_pass http://$web_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
