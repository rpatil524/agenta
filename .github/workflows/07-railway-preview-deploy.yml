name: "07 - railway preview: deploy"

on:
  workflow_call:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g. pr-123-abc1234)"
        required: true
        type: string
      pr_number:
        description: "PR number"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy"
        required: true
        type: string
      pr_number:
        description: "PR number"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: railway-preview-deploy-${{ inputs.pr_number }}
  cancel-in-progress: true

env:
  RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/railwayapp/cli/master/install.sh | sh
          railway --version

      - name: Install jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Deploy preview environment
        id: deploy
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          SMOKE_AUTO_REPAIR: "false"
          SMOKE_MAX_RETRIES: "20"
          SMOKE_SLEEP_SECONDS: "10"
        run: |
          chmod +x hosting/railway/oss/scripts/*.sh
          output="$(hosting/railway/oss/scripts/preview-create-or-update.sh 2>&1)" || {
            echo "$output"
            echo "deploy_failed=true" >> "$GITHUB_OUTPUT"
            exit 1
          }
          echo "$output"

          # Extract preview URL from output
          url="$(echo "$output" | grep -oP 'Preview URL: \K.*' || true)"
          echo "preview_url=${url}" >> "$GITHUB_OUTPUT"

          # Extract project name from output
          project="$(echo "$output" | grep -oP "Preview deploy completed for '\K[^']*" || true)"
          echo "project_name=${project}" >> "$GITHUB_OUTPUT"

      - name: Post preview URL as PR comment
        if: inputs.pr_number != '' && steps.deploy.outputs.preview_url != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');
            const previewUrl = '${{ steps.deploy.outputs.preview_url }}';
            const projectName = '${{ steps.deploy.outputs.project_name }}';
            const imageTag = '${{ inputs.image_tag }}';
            const marker = '<!-- railway-preview-bot -->';

            const body = [
              marker,
              '### Railway Preview Environment',
              '',
              `| | |`,
              `|---|---|`,
              `| **Preview URL** | ${previewUrl} |`,
              `| **Project** | \`${projectName}\` |`,
              `| **Image tag** | \`${imageTag}\` |`,
              `| **Status** | Deployed |`,
              '',
              `_Updated at ${new Date().toISOString()}_`,
            ].join('\n');

            // Find existing comment from this bot
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

      - name: Post failure comment
        if: failure() && inputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}');
            const imageTag = '${{ inputs.image_tag }}';
            const marker = '<!-- railway-preview-bot -->';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              marker,
              '### Railway Preview Environment',
              '',
              `| | |`,
              `|---|---|`,
              `| **Image tag** | \`${imageTag}\` |`,
              `| **Status** | Failed |`,
              `| **Logs** | [View workflow run](${runUrl}) |`,
              '',
              `_Updated at ${new Date().toISOString()}_`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

      - name: Summary
        if: always()
        run: |
          echo "### Railway Preview Deploy" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **PR:** #${{ inputs.pr_number }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image tag:** \`${{ inputs.image_tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${{ steps.deploy.outputs.preview_url }}" ]; then
            echo "- **Preview URL:** ${{ steps.deploy.outputs.preview_url }}" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- **Project:** \`${{ steps.deploy.outputs.project_name }}\`" >> "$GITHUB_STEP_SUMMARY"
